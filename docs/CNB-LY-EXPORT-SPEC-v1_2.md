# CNB LilyPond Export Format Specification

**Version:** 1.2 (Cumulative Rules & Accessible Color Switching)
**Date:** February 24, 2026
**Status:** Updated for cumulative notehead rules, palette-based color system, accessible color switching, and inline staff/ledger styling. Procedure model is the only model.
**Companion document:** CNB-PROJECT-PLAN-20260224.md
**Reference implementation:** `Kite-4-369-Notation-Procedure.ly`

---

## 1. PURPOSE

This document specifies the structure and content of `.ly` files generated by the Chromatic Configurator. These files configure the CNB engine to render a specific chromatic notation system.

The `.ly` export is a one-way artifact. The Configurator generates it; LilyPond consumes it. The Configurator's native save format (JSON) preserves the full editing state.

### 1.1 Changes from v1.1

- **Cumulative notehead rules.** Section C is now generated from layered rules (shape, hollow, color) rather than monolithic first-match-wins rules.
- **Palette-based color naming.** Colors are auto-named via `nearestColorName()` (e.g., `shamrock-1b9e77`).
- **Accessible color switching.** Section A emits a conditional block that registers primary or CB-safe colors based on `cnb:use-accessible-colors`.
- **Staff/ledger line styling.** Thickness expressed as % of semitone height, converted to absolute units at export.
- **Display-only settings.** Stem thickness and length for preview are NOT exported (display-only in the Configurator).

---

## 2. FILE STRUCTURE OVERVIEW

Every exported `.ly` file has this structure, in this order:

```
┌─────────────────────────────────────────┐
│  File Header                            │
│    - LilyPond version declaration       │
│    - Engine include                     │
│    - Generated-by comment block         │
├─────────────────────────────────────────┤
│  Section A — Named Definitions          │
│    A1. Path definitions                 │
│    A2. Path registrations               │
│    A3. Hollow cutout registrations      │
│    A4. Stem attachment registrations    │
│    A5. Color registrations (conditional)│
│    A6. Off-key mark registrations       │
├─────────────────────────────────────────┤
│  Section B — Engine Settings            │
│    B1. Staff geometry                   │
│    B2. Display settings                 │
│    B3. Metadata                         │
├─────────────────────────────────────────┤
│  Section C — Configuration Procedure    │
│    The cnb:get-notehead-config lambda   │
└─────────────────────────────────────────┘
```

**Ordering is mandatory.** Section A before B before C.

---

## 3. FILE HEADER

```lilypond
\version "2.24.2"
\include "ChromaticNotationBase.ly"

%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%
%% <notation-label> — Generated by Chromatic Configurator
%% Date: <ISO date>
%% Configurator version: <version>
%%
%% DO NOT EDIT BY HAND — regenerate from the Configurator.
%% Source: <json-filename> (if known)
%%
%% Color palette: <palette-name> (<mode>)
%% Set cnb:use-accessible-colors to #t before \include to use
%% the colorblind-safe alternative palette.
%%
%% %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
```

### 3.1 Comment Conventions

- Use `%%` for all comments outside Scheme blocks.
- Inside `#( ... )` Scheme blocks, use `;;` — but only on lines purely within the Scheme expression.
- Never place `;;` after the closing paren of a `#( ... )` block.

---

## 4. SECTION A — NAMED DEFINITIONS

### 4.1 Path Definitions (A1)

**When `data-lilypond-notehead` is available** (preferred path):

The Configurator reads the pre-baked LilyPond path string directly from the SVG's `data-lilypond-notehead` attribute and emits it verbatim:

```lilypond
#(define cnb:my-shape-path '(
    (moveto 0.8 0)
    (curveto 0.8 -0.56 0.44 -1.0 0 -1.0)
    (curveto -0.44 -1.0 -0.8 -0.56 -0.8 0)
    (curveto -0.8 0.56 -0.44 1.0 0 1.0)
    (curveto 0.44 1.0 0.8 0.56 0.8 0)
    (closepath)))
```

**When `data-lilypond-notehead` is not available** (fallback):

The Configurator converts the SVG path `d` attribute using `svgPathToLilypond()`.

**No rotation or scaling in generated code.** Each shape variant is a separate SVG with its own pre-baked path.

### 4.2 Path Registrations (A2)

```lilypond
#(cnb:register-path! 'my-shape cnb:my-shape-path)
```

### 4.3 Hollow Cutout Registrations (A3)

Same approach as paths — prefer `data-lilypond-hollow` from the SVG, fall back to conversion.

```lilypond
#(define cnb:my-shape-cutout-path '(
    (moveto 0.5 0)
    (curveto 0.5 -0.36 0.28 -0.64 0 -0.64)
    ...
    (closepath)))

#(cnb:register-hollow! 'my-shape-cutout cnb:my-shape-cutout-path)
```

### 4.4 Stem Attachment Registrations (A4)

Attachment points use the 4-point model: crotchet-up, crotchet-down, minim-up, minim-down.

```lilypond
#(cnb:register-attachment! 'my-shape-attach
   (list
     (cons 'crotchet-up   '(0.6889 . 0))
     (cons 'crotchet-down '(-0.6889 . 0))
     (cons 'minim-up      '(1.0222 . 0))
     (cons 'minim-down    '(-0.6889 . 0))))
```

### 4.5 Color Registrations — with Accessible Color Switching (A5)

**This is new in v1.2.** The Configurator emits a conditional block that registers either the primary palette colors or their colorblind-safe alternatives.

```lilypond
%% Color registrations
%% Primary palette: Dark2 · 7 colors (Standard)
%% Accessible palette: auto-generated CB-safe match
%%
%% Usage: Set cnb:use-accessible-colors to #t before \include
%% to activate the colorblind-safe alternative.

#(if (and (defined? 'cnb:use-accessible-colors) cnb:use-accessible-colors)
  (begin
    ;; Accessible (colorblind-safe) palette
    (cnb:register-color! 'shamrock-1b9e77 "#009f81")
    (cnb:register-color! 'orange-d95f02 "#ff6e3a")
    (cnb:register-color! 'lilac-7570b3 "#0058cb"))
  (begin
    ;; Primary palette
    (cnb:register-color! 'shamrock-1b9e77 "#1b9e77")
    (cnb:register-color! 'orange-d95f02 "#d95f02")
    (cnb:register-color! 'lilac-7570b3 "#7570b3")))
```

**Key design points:**
- Symbol names are identical in both branches. Section C always references the same symbols.
- For monochrome palettes, both branches register `black-000000 → "#000000"` (identity mapping).
- For CB-safe-as-primary mode, both branches have the same hex values (identity mapping).
- The `defined?` guard allows the config to work even if the programmer doesn't define the flag.
- Line palette colors (for staff/ledger lines) are registered in the same block.

**Color name generation:**
- The `music-color-palettes.js` library's `nearestColorName()` produces names like `"Shamrock-#1b9e77"`.
- The Configurator converts these to Scheme symbols via `toSchemeSymbol()`: `shamrock-1b9e77`.
- The hex suffix ensures uniqueness when two different colors map to the same color name.

### 4.6 Off-Key Mark Registrations (A6)

Only needed for custom off-key marks. Built-in marks do not need registration.

---

## 5. SECTION B — ENGINE SETTINGS

### 5.1 Always Emitted

```lilypond
%% Staff geometry
#(set! cnb:semitones-per-staff-space 3)
#(set! cnb:staff-line-positions '(-6 -4 -2 2 4 6))

%% Metadata
#(set! cnb:file-suffix "-MyNotation")
#(set! cnb:notation-label "My Notation System")
```

### 5.2 Emit-If-Changed Settings

These are emitted only when they differ from engine defaults:

| Variable | Default | Emit when |
|----------|---------|-----------|
| `cnb:false-hollow` | `#f` | Changed to `#t` |
| `cnb:multinote-padding` | `-0.5` | Changed |
| `cnb:default-magnify` | `7/4` | Changed |
| `cnb:indent` | `0` | Changed |
| `cnb:collision-threshold` | `2` | Changed |
| `cnb:default-staff-line-thickness` | `2` | Changed |
| `cnb:default-staff-line-color` | `"#000000"` | Changed |
| `cnb:stem-thickness` | (auto) | When explicitly set |

### 5.3 Staff/Ledger Line Thickness

Staff and ledger line thicknesses are configured in the Configurator as a percentage of semitone height. At export time, they are converted to absolute units:

```
absolute_thickness = (percentage / 100) × semitone_height_in_staff_spaces
```

Where `semitone_height_in_staff_spaces = 1.0` (one semitone = one staff-space unit in LilyPond when `semitones-per-staff-space = 1`, or `1/sps` when `sps > 1`).

Default percentages: staff lines 20%, ledger lines 40%.

### 5.4 Notation Footnote

Emitted only when non-empty:

```lilypond
#(set! cnb:notation-footnote "Description of this notation system")
```

---

## 6. SECTION C — CONFIGURATION PROCEDURE

### 6.1 Generation from Cumulative Rules

The Configurator resolves all 12 pitch classes by walking the cumulative rules (shape, hollow, color) top-to-bottom, last-match-wins per property. Then it groups pitch classes with identical final configs into `cond` clauses.

**Defaults** (before any rules apply): shape = first shape in defs, hollow = `#f`, color = `black-000000`.

```lilypond
#(set! cnb:get-notehead-config
   (lambda (semitone duration key)
     (let ((pc (modulo semitone 12)))
       (cond
         ;; C, E, G♯ → kite-up, solid, shamrock
         ((memv pc '(0 4 8))
          '((shape      . kite-up)
            (color      . shamrock-1b9e77)
            (hollow     . #f)
            (attachment . kite-up-attach)
            (off-key-mark . #f)))

         ;; C♯, D♯, F → kite-down, hollow, orange
         ((memv pc '(1 3 5))
          '((shape      . kite-down)
            (color      . orange-d95f02)
            (hollow     . kite-down-cutout)
            (attachment . kite-down-attach)
            (off-key-mark . #f)))

         ;; D, F♯, A♯ → kite-up, solid, lilac
         ((memv pc '(2 6 10))
          '((shape      . kite-up)
            (color      . lilac-7570b3)
            (hollow     . #f)
            (attachment . kite-up-attach)
            (off-key-mark . #f)))

         ;; G, A, B → kite-down, hollow, pink
         ((memv pc '(7 9 11))
          '((shape      . kite-down)
            (color      . pink-e7298a)
            (hollow     . kite-down-cutout)
            (attachment . kite-down-attach)
            (off-key-mark . #f)))

         ;; Fallback
         (else
          '((shape      . kite-up)
            (color      . shamrock-1b9e77)
            (hollow     . #f)
            (attachment . kite-up-attach)
            (off-key-mark . #f)))))))
```

Note: The Section C output uses `(let ((pc (modulo semitone 12))) ...)` and `memv` to group pitch classes, rather than individual `(= semitone N)` clauses. This is more compact when multiple pitch classes share the same resolved config.

### 6.2 Duration/Key-Aware Rules (Future)

When duration and key fields are enabled in rules, the `cond` conditions will become compound:

```scheme
((and (memv pc '(0 4 8)) (= duration 3))  ;; quarter notes only
 '((shape . kite-up) ...))
```

This is deferred to a future phase.

---

## 7. SVG DATA ATTRIBUTES REFERENCE

### 7.1 Attributes Set by Music Glyph Toolkit

| Attribute | Element | Value | Example |
|-----------|---------|-------|---------|
| `data-semitone-height` | `#notehead` | Float (semitones) | `"2.0"` |
| `data-stem-up-x` | `#notehead` | Float (SVG units) | `"68.889"` |
| `data-stem-up-y` | `#notehead` | Float (SVG units) | `"0.0"` |
| `data-stem-down-x` | `#notehead` | Float (SVG units) | `"-68.889"` |
| `data-stem-down-y` | `#notehead` | Float (SVG units) | `"0.0"` |

### 7.2 Planned Attributes (Phase 4)

| Attribute | Element | Value | Example |
|-----------|---------|-------|---------|
| `data-lilypond-notehead` | `#notehead` | LilyPond path string | `"'((moveto 0.8 0) ...)"` |
| `data-lilypond-hollow` | `#hollow` | LilyPond path string | `"'((moveto 0.5 0) ...)"` |

---

## 8. EXPORT VALIDATION

Before generating the `.ly` file, the Configurator validates:

1. Every shape referenced by shape rules has been imported and has path data.
2. Every hollow reference has corresponding hollow path data.
3. All palette colors referenced by color rules exist in the active palette.
4. All 12 pitch classes are covered by at least one shape rule.
5. At least 2 staff lines are defined.
6. `cnb:file-suffix` begins with a hyphen (if non-empty).
7. Color hex values match `#RRGGBB` format.

Warnings (non-blocking):
- Notation label is empty.
- A pitch class is assigned hollow but its shape has no hollow path.
- Shape was imported without `data-lilypond-*` (using fallback conversion).
- Some pitch classes have no color rule (will use default black).
- CB-safe alternative has high ΔE (poor match) for some colors.

---

## APPENDIX A: ENGINE API QUICK REFERENCE

### Registration Functions

| Function | Arguments | Table |
|----------|-----------|-------|
| `cnb:register-path!` | `(symbol, path-data)` | `cnb:path-defs` |
| `cnb:register-hollow!` | `(symbol, path-data)` | `cnb:hollow-defs` |
| `cnb:register-attachment!` | `(symbol, alist)` | `cnb:attachment-defs` |
| `cnb:register-off-key-mark!` | `(symbol, path-data)` | `cnb:off-key-mark-defs` |
| `cnb:register-color!` | `(symbol, hex-string)` | `cnb:color-defs` |

### Engine Settings

| Variable | Type | Default | Required |
|----------|------|---------|----------|
| `cnb:semitones-per-staff-space` | Integer | `2` | Always |
| `cnb:staff-line-positions` | List | `'(-4 -2 0 2 4)` | Always |
| `cnb:false-hollow` | Boolean | `#f` | If changed |
| `cnb:multinote-padding` | Number | `-.5` | If changed |
| `cnb:default-magnify` | Number | `7/4` | If changed |
| `cnb:indent` | Number | `0` | If changed |
| `cnb:collision-threshold` | Number | `2` | If changed |
| `cnb:default-staff-line-thickness` | Number | `2` | If changed |
| `cnb:default-staff-line-color` | String | `"#000000"` | If changed |
| `cnb:stem-thickness` | Number | (auto) | If set |
| `cnb:use-accessible-colors` | Boolean | `#f` | **New v1.2** |
| `cnb:file-suffix` | String | `""` | Always |
| `cnb:notation-label` | String | `""` | Always |
| `cnb:notation-footnote` | String | `""` | If non-empty |

### Procedure Return Alist

| Field | Type | Resolves Via |
|-------|------|-------------|
| `shape` | Symbol | `cnb:path-defs` |
| `color` | Symbol / String | `cnb:color-defs` / passthrough |
| `hollow` | `#f` or Symbol | `cnb:hollow-defs` |
| `attachment` | Symbol | `cnb:attachment-defs` |
| `off-key-mark` | `#f` or Symbol | `cnb:off-key-mark-defs` or built-in |

---

## CHANGE LOG

| Version | Date | Changes |
|---------|------|---------|
| 1.0 | Feb 21, 2026 | Initial specification |
| 1.1 | Feb 23, 2026 | Inkscape extension integration. Vector model removed. Pre-baked LilyPond path support. |
| **1.2** | **Feb 24, 2026** | **Cumulative notehead rules. Palette-based color naming (`nearestColorName`). Accessible color switching (`cnb:use-accessible-colors` conditional block in Section A). Section C uses `memv`/`let` grouping. Inline staff/ledger thickness as % of semitone height. Display-only settings (stem preview) clarified as non-exported.** |
